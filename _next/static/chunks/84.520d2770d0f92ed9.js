!function(){var t,e,n,r,o,i,a={2040:function(t,e,n){"use strict";var r,o;t.exports=(null==(r=n.g.process)?void 0:r.env)&&"object"==typeof(null==(o=n.g.process)?void 0:o.env)?n.g.process:n(6003)},7084:function(t,e,n){"use strict";let r,o,i;var a=n(2687);class s{async loadModel(t,e,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:self.crossOriginIsolated;this.n_layer=e,this.n_embd=n,a.env.wasm.proxy=!0,r?(a.env.wasm.numThreads=Math.max(1,.5*navigator.hardwareConcurrency,navigator.hardwareConcurrency-4),console.log("Using WASM backend with "+a.env.wasm.numThreads+" threads")):console.log("Using WASM backend with 1 thread (crossOriginIsolated = false)"),a.env.logLevel="verbose";let o={executionProviders:["wasm"],graphOptimizationLevel:"all"};t.endsWith(".ort")&&(o={executionProviders:["wasm"],enableMemPattern:!1,enableCpuMemArena:!1,extra:{session:{disable_prepacking:"1",use_device_allocator_for_initializers:"0",use_ort_model_bytes_directly:"1",use_ort_model_bytes_for_initializers:"1"}}}),a.env.wasm.wasmPaths="",this.session=await a.InferenceSession.create(t,o)}async forward(t,e){let n;if(null===this.session)throw Error("Model not loaded");let r=null;if(null===e){let t=new Float32Array(5*this.n_layer*this.n_embd).fill(0);for(let e=0;e<this.n_layer;e++)t.fill(-1e30,(5*e+4)*this.n_embd,(5*e+5)*this.n_embd);e=new a.Tensor(t,[5*this.n_layer,this.n_embd])}if(0===(n="number"==typeof t?new Int32Array([t]):t instanceof Int32Array?t:t.data).length)throw Error("Context must not be empty");for(let t=0;t<n.length;t++){let o=n[t],i={idx:new a.Tensor("int32",[o],[1]),state:e},s=await this.session.run(i);e=s.state_r,r=s.x}return{x:r,state:e}}constructor(){this.session=null,this.n_layer=0,this.n_embd=0}}class l{async loadTokenizer(t){let e=await fetch(t);for(let[t,n]of(this.tokenizer=await e.json(),Object.entries(this.tokenizer.model.vocab)))this.encoder[t]=n,this.decoder[n]=t}tokenize(t){return t.split(" ")}encode(t){if(!this.encoder)throw Error("Encoder not loaded");let e=this.tokenize(t),n=e.map(t=>this.encoder[t]);return new Int32Array(n)}decode(t){if(!this.decoder)throw Error("Decoder not loaded");if(t instanceof Int32Array&&(t=Array.from(t)),"number"==typeof t)return this.decoder[t];let e=t.map(t=>this.decoder[t]);return e.join(" ")}constructor(){this.encoder={},this.decoder={}}}class c{async load(t){let e=await fetch(t),n=await e.json();this.config=n}binToVelocity(t){if(!this.config)throw Error("vocab config is not loaded");let e=this.config.velocity_events/(this.config.velocity_bins-1);return 1==this.config.velocity_exp?Math.max(0,Math.ceil(t*e-1))/(this.config.velocity_events-1):Math.max(0,Math.ceil(this.config.velocity_events*Math.log((this.config.velocity_exp-1)*e*t/this.config.velocity_events+1)/Math.log(this.config.velocity_exp)-1))/(this.config.velocity_events-1)}waitTokenToDelta(t){if(!this.config)throw Error("vocab config is not loaded");return this.config.max_wait_time/this.config.wait_events*parseInt(t.substring(1))/1e3}noteTokenToData(t){if(!this.config)throw Error("vocab config is not loaded");let[e,n,r]=t.trim().split(":"),o=parseInt(n,16),i=this.binToVelocity(parseInt(r,16));return{instrument:0,pitch:o,velocity:i}}tokenToData(t){return"<end>"===t?5:t.startsWith("<")?0:t.startsWith("t")?this.waitTokenToDelta(t):this.noteTokenToData(t)}constructor(){}}var u=n(2040);let f=u.env.BASE_PATH||"/aipiano",h=!1,d=!1,p=[],m=!1,g=!1,y="",v=0,T=0,w=0,_=0,b={},x=[];async function k(){h=!0;let t=[];r||t.push((r=new s).loadModel("".concat(f,"/static/gmp_tiny2_uint8.onnx"),20,320)),o||t.push((o=new l).loadTokenizer("".concat(f,"/static/tokenizer-midipiano.json"))),i||t.push((i=new c).load("".concat(f,"/static/vocab_config_piano.json"))),t.length&&(self.postMessage("loading"),await Promise.all(t),self.postMessage("loaded")),p=[],x=[],b={},_=0;let e=v,n=w=0;if(self.postMessage({message:"notes",notes:[],notesTotalTime:w,promptEndTime:_}),y){let t=0;o.tokenize(y).forEach(e=>{E(i.tokenToData(e)),t++%10==0&&self.postMessage({message:"notes",notes:[...x,...Object.values(b)],notesTotalTime:w,promptEndTime:_})})}for(_=w,M(y);!d;){let t=!1;for(e!==v&&(x=x.filter(t=>t.startTime+t.duration>=v),e=v,t=!0);w<T&&p.length>0&&x.length+Object.keys(b).length<256;){let e=p.shift();void 0!==e&&E(e),n!==w&&(n=w,t=!0)}t&&self.postMessage({message:"notes",notes:[...x,...Object.values(b)],notesTotalTime:w,promptEndTime:_}),await new Promise(t=>setTimeout(t,100))}for(g=!0;m;)await new Promise(t=>setTimeout(t,100));h=!1}async function M(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";if(m)throw Error("Already generating");g=!1,m=!0;let e=null,n=t?o.encode(t):0,a=new Int32Array(125);for(let t=0;t<a.length;t++)a[t]=t+3;let s=new Int32Array(128);n instanceof Int32Array?s.set(n.subarray(Math.max(0,n.length-128+1))):s[-1]=n;t:for(;;){if(g)break t;for(;p.length>=64;){if(g)break t;await new Promise(t=>setTimeout(t,100))}let t=await r.forward(n,e);e=t.state,(0===(n=function(t,e){let{greedy:n=!1,temperature:r=1,top_p:o=0,repetition_penalty:i,preProcessProbs:a,postProcessProbs:s}=e;if(n)return function(t){let e=0,n=t[0],r=t.length;for(let o=1;o<r;o++)t[o]>n&&(e=o,n=t[o]);return e}(t);let l=function(t){let e=-1/0;for(let n=0;n<t.length;n++)t[n]>e&&(e=t[n]);let n=0,r=new Float32Array(t.length);for(let o=0;o<t.length;o++){let i=Math.exp(t[o]-e);r[o]=i,n+=i}for(let e=0;e<t.length;e++)r[e]/=n;return r}(t);if(a&&(l=a(l)),i){let{prev_ids:e,penalty:n,view_length:r,max_penalty:o,decay_factor:a,exclude_ids:s}=i,l=new Float32Array(r);for(let t=0;t<r;t++)l[t]=Math.pow(a,r-t-1);let c=new Float32Array(t.length);for(let t=0;t<e.length;t++)c[e[t]]=l[t];for(let t=0;t<s.length;t++)c[s[t]]=0;let u=new Float32Array(t.length);for(let e=0;e<t.length;e++){let r=Math.pow(t[e]<0?n:1/n,c[e]);r=Math.min(Math.max(r,1/o),o),u[e]=r}for(let e=0;e<t.length;e++)t[e]*=u[e]}if(0!==o){let t=function(t,e){let n=t.slice().sort();for(let t=n.length-1;t>=0;t--)if((e-=n[t])<0)return n[t];return n[n.length-1]}(l,o);for(let e=0;e<l.length;e++)l[e]<t&&(l[e]=0)}if(1!==r)for(let t=0;t<l.length;t++)l[t]=Math.pow(l[t],1/r);return s&&(l=s(l)),function(t){let e=t.reduce((t,e)=>t+e,0),n=Math.random()*e;for(let e=0;e<t.length;e++)if((n-=t[e])<=0)return e;return t.length-1}(l)}(t.x.data,{temperature:1,top_p:.8,repetition_penalty:{prev_ids:s,penalty:1.1,view_length:128,max_penalty:1.5,decay_factor:.99,exclude_ids:a},preProcessProbs:t=>(t[0]=0,t.fill(0,128,270),t.fill(0,1680,2175),t)}))||2===n)&&(e=null),s.set(s.subarray(1),0),s[s.length-1]=n;let l=o.decode(n);if("<pad>"===l)break t;p.push(i.tokenToData(l))}p=[],m=!1}function E(t){let e="hsl("+360*w/30+", 50%, 50%)";if("number"==typeof t)w+=t,Object.values(b).forEach(t=>{var e;if(w-t.startTime>=((null===(e=i.config)||void 0===e?void 0:e.decode_end_held_note_delay)||8)){let e={pitch:t.pitch,velocity:t.velocity,startTime:t.startTime,duration:Math.max(w-t.startTime,.1),color:t.color};x.push(e),delete b[t.pitch]}});else if(t.velocity<=.01){let e=b[t.pitch];if(void 0!==e){let n=w-e.startTime;if(n>0){let r={pitch:e.pitch,velocity:e.velocity,startTime:e.startTime,duration:Math.max(n,.1),color:e.color};x.push(r),delete b[t.pitch]}}}else{let n=b[t.pitch];if(void 0!==n){let e={pitch:n.pitch,velocity:n.velocity,startTime:n.startTime,duration:Math.max(w-n.startTime,.1),color:n.color};x.push(e),delete b[t.pitch]}let r={pitch:t.pitch,velocity:t.velocity,startTime:w,color:e};b[t.pitch]=r}}self.onmessage=t=>{let e=t.data.message||t.data;"start"===e&&(async()=>{for(y=t.data.prompt||"",v=t.data.minNotesTotalTime||0,T=t.data.maxNotesTotalTime||0,t.data.crossOriginIsolated,d=!0;h&&d;)await new Promise(t=>setTimeout(t,100));h||(d=!1,k())})(),"stop"===e&&(d=!0),"updateTime"===e&&(T=t.data.maxNotesTotalTime||0,v=t.data.minNotesTotalTime||0)}},6003:function(t){!function(){var e={229:function(t){var e,n,r,o=t.exports={};function i(){throw Error("setTimeout has not been defined")}function a(){throw Error("clearTimeout has not been defined")}function s(t){if(e===setTimeout)return setTimeout(t,0);if((e===i||!e)&&setTimeout)return e=setTimeout,setTimeout(t,0);try{return e(t,0)}catch(n){try{return e.call(null,t,0)}catch(n){return e.call(this,t,0)}}}!function(){try{e="function"==typeof setTimeout?setTimeout:i}catch(t){e=i}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(t){n=a}}();var l=[],c=!1,u=-1;function f(){c&&r&&(c=!1,r.length?l=r.concat(l):u=-1,l.length&&h())}function h(){if(!c){var t=s(f);c=!0;for(var e=l.length;e;){for(r=l,l=[];++u<e;)r&&r[u].run();u=-1,e=l.length}r=null,c=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function p(){}o.nextTick=function(t){var e=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];l.push(new d(t,e)),1!==l.length||c||s(h)},d.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=p,o.addListener=p,o.once=p,o.off=p,o.removeListener=p,o.removeAllListeners=p,o.emit=p,o.prependListener=p,o.prependOnceListener=p,o.listeners=function(t){return[]},o.binding=function(t){throw Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(t){throw Error("process.chdir is not supported")},o.umask=function(){return 0}}},n={};function r(t){var o=n[t];if(void 0!==o)return o.exports;var i=n[t]={exports:{}},a=!0;try{e[t](i,i.exports,r),a=!1}finally{a&&delete n[t]}return i.exports}r.ab="//";var o=r(229);t.exports=o}()}},s={};function l(t){var e=s[t];if(void 0!==e)return e.exports;var n=s[t]={exports:{}},r=!0;try{a[t](n,n.exports,l),r=!1}finally{r&&delete s[t]}return n.exports}l.m=a,l.x=function(){var t=l.O(void 0,[343],function(){return l(7084)});return l.O(t)},t=[],l.O=function(e,n,r,o){if(n){o=o||0;for(var i=t.length;i>0&&t[i-1][2]>o;i--)t[i]=t[i-1];t[i]=[n,r,o];return}for(var a=1/0,i=0;i<t.length;i++){for(var n=t[i][0],r=t[i][1],o=t[i][2],s=!0,c=0;c<n.length;c++)a>=o&&Object.keys(l.O).every(function(t){return l.O[t](n[c])})?n.splice(c--,1):(s=!1,o<a&&(a=o));if(s){t.splice(i--,1);var u=r();void 0!==u&&(e=u)}}return e},l.f={},l.e=function(t){return Promise.all(Object.keys(l.f).reduce(function(e,n){return l.f[n](t,e),e},[]))},l.u=function(t){return"static/chunks/0a847d09.24246cd35b53dda5.js"},l.miniCssF=function(t){},l.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(t){if("object"==typeof window)return window}}(),l.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},l.tt=function(){return void 0===e&&(e={createScriptURL:function(t){return t}},"undefined"!=typeof trustedTypes&&trustedTypes.createPolicy&&(e=trustedTypes.createPolicy("nextjs#bundler",e))),e},l.tu=function(t){return l.tt().createScriptURL(t)},l.p="/aipiano//_next/",n={84:1},l.f.i=function(t,e){n[t]||importScripts(l.tu(l.p+l.u(t)))},o=(r=self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push.bind(r),r.push=function(t){var e=t[0],r=t[1],i=t[2];for(var a in r)l.o(r,a)&&(l.m[a]=r[a]);for(i&&i(l);e.length;)n[e.pop()]=1;o(t)},i=l.x,l.x=function(){return l.e(343).then(i)},_N_E=l.x()}();